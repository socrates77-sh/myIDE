gplink-1.6.1 (Jan 23 2014)
Listing File Generated: 2014-6-17  09:52:27
 
 
Address  Value    Disassembly              Source
-------  -----    -----------              ------
                                           ;p30--SCL
                                           ;p27--SDA
                                           
                                           #include "mc33p116.inc"
                                           
                                           
                                           ;mc33p116 header file 
                                           
                                           
                                           ;define must write at first row
                                                  
                                           INDF0   EQU     0X01B0
                                           INDF1   EQU     0X01B1
                                           INDF2   EQU     0X01B2
                                           HIBYTE  EQU     0X01B3
                                           FSR0    EQU     0X01B4
                                           FSR1    EQU     0X1B5
                                           PCL     EQU     0X1B6
                                           PFLAG   EQU     0X1B7
                                           MCR     EQU     0X1B8
                                           INDF3   EQU     0X1B9   
                                           INTE    EQU     0X1BA
                                           INTFLAG EQU     0X1BB
                                           OSCM    EQU     0X1BC
                                           LVDCR   EQU     0X1BD  ;
                                           LXTCR   EQU     0X1BE  ;
                                           LXTCP   EQU     0X1BF  ;
                                           IOP0    EQU     0X1C0
                                           OEP0    EQU     0X1C1
                                           PUP0    EQU     0X1C2
                                           DKWP0   EQU     0X1C3  ;
                                           IOP1    EQU     0X1C4
                                           OEP1    EQU     0X1C5
                                           PUP1    EQU     0X1C6
                                           LCDIOSP1 EQU    0X1C7 ;
                                           IOP2    EQU     0X1C8
                                           OEP2    EQU     0X1C9
                                           PUP2    EQU     0X1CA
                                           LCDIOSP2 EQU    0X1CB ;
                                           IOP3    EQU     0X1CC
                                           OEP3    EQU     0X1CD
                                           PUP3    EQU     0X1CE
                                           LCDIOSP3 EQU    0X1CF ;
                                           IOP4    EQU     0X1D0	 ;
                                           OEP4    EQU     0X1D1  ;
                                           PUP4    EQU     0X1D2  ;
                                           LCDIOSP4 EQU    0X1D3 ;
                                           IOP5    EQU     0X1D4  ;
                                           OEP5    EQU     0X1D5  ;
                                           PUP5    EQU     0X1D6  ;
                                           LCDIOSP5 EQU    0X1D7 ;
                                           
                                           
                                           T0CR0    EQU     0X1D8  ;
                                           T0CR1    EQU     0X1D9  ;
                                           T0LOADH  EQU     0X1DC  ;
                                           T0LOADL  EQU     0X1DD  ;
                                           T0DATAH  EQU     0X1DE  ;
                                           T0DATAL  EQU     0X1DF  ;
                                           T0LATRH  EQU     0X1E0  ;
                                           T0LATRL  EQU     0X1E1  ;
                                           T0LATFH  EQU     0X1E2  ;
                                           T0LATFL  EQU     0X1E3  ;
                                           
                                           T1CR     EQU     0X1E4  ;
                                           T1DATA   EQU     0X1E5  ;
                                           T1LOAD   EQU     0X1E6  ;
                                           
                                           ADCR0   EQU     0X1E8  ;
                                           ADCR1   EQU     0X1E9  ;
                                           ADCR2   EQU     0X1EA  ;
                                           ADDRH   EQU     0X1EC  ;
                                           ADDRL   EQU     0X1ED  ;
                                           
                                           OPCR0   EQU     0X1F0  ;
                                           OPCR1   EQU     0X1F1  ;
                                           LCDCR0  EQU     0X1F2  ;
                                           LCDCR1  EQU     0X1F3  ;
                                           DKW     EQU     0X1F4  ;
                                           KBCR    EQU     0X1F5  ;
                                           LCDDRV  EQU     0X1F6  ;
                                           
                                           ;PFLAG
                                           #define         Z			PFLAG,2
                                           #define         DC		PFLAG,1
                                           #define         C			PFLAG,0
                                           
                                           ;int 
                                           #define         GIE       MCR,7
                                           #define         TO        MCR,5
                                           #define         PD        MCR,4
                                           #define         MINT11		MCR,3
                                           #define         MINT10		MCR,2
                                           #define         MINT01		MCR,1
                                           #define         MINT00		MCR,0
                                             
                                           
                                           ;INTE
                                           ; 1=enable, 0=disable
                                           #define         ADIE    INTE,7
                                           #define         LVDIE   INTE,5
                                           #define         KBIE    INTE,4
                                           #define         INT1IE  INTE,3
                                           #define         INT0IE  INTE,2
                                           #define         T1IE    INTE,1
                                           #define         T0IE    INTE,0
                                           
                                           ;INTFLAG
                                           ;1=active ,
                                           #define         ADIF    INTFLAG,7 
                                           #define         T0RF    INTFLAG,6
                                           #define         LVDIF   INTFLAG,5
                                           #define         KBIF    INTFLAG,4
                                           #define         INT1IF  INTFLAG,3
                                           #define         INT0IF  INTFLAG,2
                                           #define         T1IF    INTFLAG,1
                                           #define         T0IF    INTFLAG,0
                                           
                                           
                                           ;-------------------------------------------------------
                                           ;timer0
                                           ;----------------------------
                                           ;T0CR0
                                           #define			TC0EN				T0CR0,7
                                           #define 		T0MOD1			T0CR0,6
                                           #define			T0MOD0			T0CR0,5
                                           #define 		T0PTS1			T0CR0,4
                                           #define			T0PTS0			T0CR0,3
                                           #define 		T0PR2 			T0CR0,2
                                           #define			T0PR1				T0CR0,1
                                           #define 		T0PR0 			T0CR0,0
                                           ;T0CR1
                                           #define			FPWMEN 			T0CR1,7
                                           #define 		PWMEN  			T0CR1,6
                                           #define			PWMOS 			T0CR1,5
                                           #define 		FPWMS 			T0CR1,4
                                           #define			FPWMA1			T0CR1,3
                                           #define 		FPWMA0 			T0CR1,2
                                           #define			FPWMB1			T0CR1,1
                                           #define 		FPWMB0 			T0CR1,0
                                           
                                           ;-------------------------------------------------------
                                           ;timer1
                                           ;----------------------------
                                           ;T1CR
                                           #define			TC1EN 			T1CR,7
                                           #define 		T1MOD1 			T1CR,6
                                           #define			T1MOD0 			T1CR,5
                                           #define 		T1PTS1 			T1CR,4
                                           #define			T1PTS0			T1CR,3
                                           #define 		T1PR2 			T1CR,2
                                           #define			T1PR1 			T1CR,1
                                           #define 		T1PR0 			T1CR,0
                                           
                                           
                                           ;DKW
                                           #define					DKWE		DKW,7
                                           #define					IROS  	DKW,6
                                           #define					IROT  	DKW,5
                                           #define					WSEL1		DKW,4
                                           #define					WSEL0 	DKW,3
                                           #define					RSEL  	DKW,2
                                           #define					DRVS  	DKW,1
                                           #define					DSELEN	DKW,0
                                           
                                           ;LCDCR0
                                           #define					LCDEN		LCDCR0,7
                                           #define					LCDSP1	LCDCR0,6
                                           #define					LCDSP0	LCDCR0,5
                                           #define					LCDDUTY	LCDCR0,4
                                           #define					VLCDS		LCDCR0,3
                                           #define					LCDSPEED		LCDCR0,2
                                           #define					LCDRS1	LCDCR0,1
                                           #define					LCDRS0		LCDCR0,0
                                           
                                           ;ADCR0
                                           #define					ADCHS3		ADCR0,7
                                           #define					ADCHS2  	ADCR0,6
                                           #define					ADCHS1  	ADCR0,5
                                           #define					ADCHS0		ADCR0,4
                                           #define					ADCKS1 		ADCR0,3
                                           #define					ADCKS0  	ADCR0,2
                                           #define					ADEOC  		ADCR0,1
                                           #define					ADON			ADCR0,0
                                           
                                           ;ADCR1
                                           #define					ADIOS7		ADCR1,7
                                           #define					ADIOS6  	ADCR1,6
                                           #define					ADIOS5  	ADCR1,5
                                           #define					ADIOS4		ADCR1,4
                                           #define					ADIOS3 		ADCR1,3
                                           #define					ADIOS2  	ADCR1,2
                                           #define					ADIOS1 		ADCR1,1
                                           #define					ADIOS0		ADCR1,0
                                           
                                           ;ADCR2
                                           #define					VREF  		ADCR2,6
                                           #define					VLDOSL1  	ADCR2,5
                                           #define					VLDOSL0		ADCR2,4
                                           #define					TPS1			ADCR2,3
                                           #define					TPS0		  ADCR2,2
                                           #define					VREFRES 	ADCR2,1
                                           #define					VREXT			ADCR2,0
                                           
                                           ;IOP0
                                           #define					IOP07		IOP0,7
                                           #define					IOP06  	IOP0,6
                                           #define					IOP05  	IOP0,5
                                           #define					IOP04		IOP0,4
                                           #define					IOP03 	IOP0,3
                                           #define					IOP02  	IOP0,2
                                           #define					IOP01 	IOP0,1
                                           #define					IOP00		IOP0,0
                                           
                                           ;IOP1
                                           #define					IOP17		IOP1,7
                                           #define					IOP16  	IOP1,6
                                           #define					IOP15  	IOP1,5
                                           #define					IOP14		IOP1,4
                                           #define					IOP13 	IOP1,3
                                           #define					IOP12  	IOP1,2
                                           #define					IOP11 	IOP1,1
                                           #define					IOP10		IOP1,0
                                           
                                           ;IOP2
                                           #define					IOP27		IOP2,7
                                           #define					IOP26  	IOP2,6
                                           #define					IOP25  	IOP2,5
                                           #define					IOP24		IOP2,4
                                           #define					IOP23 	IOP2,3
                                           #define					IOP22  	IOP2,2
                                           #define					IOP21 	IOP2,1
                                           #define					IOP20		IOP2,0
                                           
                                           ;IOP3
                                           #define					IOP37		IOP3,7
                                           #define					IOP36  	IOP3,6
                                           #define					IOP35  	IOP3,5
                                           #define					IOP34		IOP3,4
                                           #define					IOP33 	IOP3,3
                                           #define					IOP32  	IOP3,2
                                           #define					IOP31 	IOP3,1
                                           #define					IOP30		IOP3,0
                                                        
                                           ;IOP4
                                           #define					IOP47		IOP4,7
                                           #define					IOP46  	IOP4,6
                                           #define					IOP45  	IOP4,5
                                           #define					IOP44		IOP4,4
                                           #define					IOP43 	IOP4,3
                                           #define					IOP42  	IOP4,2
                                           #define					IOP41 	IOP4,1
                                           #define					IOP40		IOP4,0
                                           
                                           ;IOP5
                                           #define					IOP55  	IOP5,5
                                           #define					IOP54		IOP5,4
                                           #define					IOP53 	IOP5,3
                                           #define					IOP52  	IOP5,2
                                           #define					IOP51 	IOP5,1
                                           #define					IOP50		IOP5,0
                                           
                                           ;OSCM
                                           #define					STBL  	OSCM,5
                                           #define					STBH		OSCM,4
                                           #define					CLKS  	OSCM,2
                                           #define					LFEN 		OSCM,1
                                           #define					HFEN		OSCM,0
                                           ;====特殊RAM=============================
                                           ;R0      equ    0x07
                                           DDR0    equ    0x45
                                           DDR1    equ    0x46
                                           PUCON   equ    0x0D
                                           
                                           ;================================================================
                                           #define         errflag        flag1,1
                                           
                                           #define         sda            IOP2,7
                                           #define         scl            IOP3,0
                                           #define         ioset          OEP2,7
                                           ;================================================================
                                           ;====ram=============================
                                           cblock        0x10 ;变量块连续定义
                                               flag1
                                           
                                               temp            ;临时寄存器
                                               temp1           ;临时寄存器
                                               address         ;地址
                                               data0           ;数据    
                                               count 
                                               
                                           
                                           endc
                                           ;===end ram=================================================
                                           
                                           ;================================================================
                                               org         0x3ff     ;复位向量
0003ff   dfb8     bclr    0x1b8, 0x7           bclr        GIE       ;关总中断
                                               org         0x00 
000000   a008     goto    0x8                  goto        sys_start
                                           ;================================================================
                                               ORG         0x08      ;中断地址
                                           ;----------------------------------------------------------------
                                           
                                           ;==start程序开始===============================================
                                           sys_start:     
000008   dfb8     bclr    0x1b8, 0x7            bclr        GIE       ;关总中断    
                                           sys_init:    
                                               ;==初始化IO==============     ; 
000009   3cff     movai   0xff                 movai     0xff
00000a   57d1     movra   0x1d1                movra     OEP4     ;p3作为输出口
00000b   57cd     movra   0x1cd                movra     OEP3     ;p3作为输出口
00000c   57c9     movra   0x1c9                movra     OEP2     ;p2作为输出口
00000d   57c5     movra   0x1c5                movra     OEP1     ;p1作为输出口 
00000e   57c1     movra   0x1c1                movra     OEP0     ;p0作为输出口 
00000f   77cc     clrr    0x1cc                clrr      IOP3           
000010   77c8     clrr    0x1c8                clrr      IOP2      
                                           
                                               
000011   cfc8     bset    0x1c8, 0x7            bset      sda
000012   c1cc     bset    0x1cc, 0              bset      scl
000013   cfca     bset    0x1ca, 0x7            bset      PUP2,7     ;上拉 
000014   3c0f     movai   0xf                  movai     15
000015   5613     movra   0x13                 movra     address
                                           
000016   3c6a     movai   0x6a                 movai     0x6a
000017   5614     movra   0x14                 movra   data0     
000018   802d     call    0x2d                 call      write24c02      ;写数据
000019   809f     call    0x9f                 call      delay10ms       ;确保数据已写入
                                               ;校验写入是否正确
00001a   3c00     movai   0                    movai     0x00
00001b   5611     movra   0x11                 movra     temp
00001c   8043     call    0x43                 call      read_24c02      ;读取数据
00001d   8071     call    0x71                 call      aknow_end_out   ;如果续读数据发送aknow_out
00001e   8098     call    0x98                 call      stopa           ;结束读数据
00001f   5814     movar   0x14                 movar     data0
000020   4811     rsubar  0x11                 rsubar    temp            ;校验写入与读出的数据是否一致
000021   e5b7     jbset   0x1b7, 0x2           jbset     Z
000022   a028     goto    0x28                 goto      check_error     
                                            
                                           check_ok:;bset   stepflag
000023   5811     movar   0x11                    movar    temp
000024   57c4     movra   0x1c4                   movra	IOP1	;read data
000025   c9cc     bset    0x1cc, 0x4              bset	IOP3,4
000026   d9cc     bclr    0x1cc, 0x4              bclr    	IOP3,4
000027   a023     goto    0x23                    goto	check_ok
                                           check_error:       
000028   5811     movar   0x11                    movar    temp
000029   57c4     movra   0x1c4                   movra   	IOP1   	;read data
00002a   cbcc     bset    0x1cc, 0x5              bset    	IOP3,5
00002b   dbcc     bclr    0x1cc, 0x5              bclr    	IOP3,5
00002c   a028     goto    0x28                    goto    	check_error       
                                           
                                           write24c02:
00002d   d210     bclr    0x10, 0x1               bclr        errflag          ;清标志位
00002e   8090     call    0x90                    call        starti2c         ;发送启动写信号
00002f   3ca0     movai   0xa0                    movai       0xa0            ;发送IC地址
000030   5611     movra   0x11                    movra       temp
000031   8082     call    0x82                    call        byte_write
000032   807a     call    0x7a                    call        aknowledge
000033   f210     jbclr   0x10, 0x1               jbclr       errflag         ;检测确认信号
000034   a02d     goto    0x2d                    goto        write24c02       ;失败的话重新发送
                                            
000035   5813     movar   0x13                    movar       address
000036   5611     movra   0x11                    movra       temp             ;发送地址
000037   8082     call    0x82                    call        byte_write
000038   807a     call    0x7a                    call        aknowledge
000039   f210     jbclr   0x10, 0x1               jbclr       errflag
00003a   a02d     goto    0x2d                    goto        write24c02
00003b   5814     movar   0x14                    movar       data0
00003c   5611     movra   0x11                    movra       temp
00003d   8082     call    0x82                    call        byte_write
00003e   807a     call    0x7a                    call        aknowledge
00003f   f210     jbclr   0x10, 0x1               jbclr       errflag         ;检测确认信号
000040   a02d     goto    0x2d                    goto        write24c02
000041   8098     call    0x98                    call        stopa
000042   000c     return                          return
                                           ;==========================================================
                                           ;==========================================================
                                           read_24c02:
000043   8090     call    0x90                    call        starti2c          ;发送启动写24c02的信号
000044   3ca0     movai   0xa0                    movai       0a0h             ;
000045   5611     movra   0x11                    movra       temp
000046   8082     call    0x82                    call        byte_write
000047   807a     call    0x7a                    call        aknowledge
000048   f210     jbclr   0x10, 0x1               jbclr       errflag         ;检测确认信号
000049   a043     goto    0x43                    goto        read_24c02       ;失败的话重新发送
00004a   5813     movar   0x13                    movar       address         ;发送地址
00004b   5611     movra   0x11                    movra       temp
00004c   8082     call    0x82                    call        byte_write
00004d   807a     call    0x7a                    call        aknowledge
00004e   f210     jbclr   0x10, 0x1               jbclr       errflag         ;检测确认信号
00004f   a043     goto    0x43                    goto        read_24c02       ;失败的话重新发送
000050   8090     call    0x90                    call        starti2c
000051   3ca1     movai   0xa1                    movai       0a1h            ;发送读字节命令
000052   5611     movra   0x11                    movra       temp
000053   8082     call    0x82                    call        byte_write
000054   807a     call    0x7a                    call        aknowledge
000055   f210     jbclr   0x10, 0x1               jbclr       errflag         ;检测确认信号
000056   a043     goto    0x43                    goto        read_24c02      ;失败的话重新发送
000057   8059     call    0x59                    call        byte_read        ;启动读数据
000058   000c     return                          return
                                           ;==========================================================
                                           ;==========================================================
                                           ;==========================================================
                                           byte_read:
000059   3c08     movai   0x8                     movai       08h
00005a   5615     movra   0x15                    movra       count
00005b   dfc9     bclr    0x1c9, 0x7              bclr        ioset
                                           read_start:
00005c   d1cc     bclr    0x1cc, 0                bclr        scl
00005d   80a8     call    0xa8                    call        delay5us
                                           read_out:
00005e   c1cc     bset    0x1cc, 0                bset        scl
00005f   d1b7     bclr    0x1b7, 0                bclr        C
000060   ffc8     jbclr   0x1c8, 0x7              jbclr       sda
000061   c1b7     bset    0x1b7, 0                bset        C
000062   5211     rlr     0x11                    rlr         temp
000063   6a15     djzr    0x15                    djzr        count
000064   a05c     goto    0x5c                    goto        read_start
000065   cfc9     bset    0x1c9, 0x7              bset        ioset
000066   d1cc     bclr    0x1cc, 0                bclr        scl
000067   000c     return                          return
                                           ;============================================================
                                           ;============================================================
                                           ;============================================================
                                           aknow_out:
000068   dfc8     bclr    0x1c8, 0x7              bclr        sda
000069   0000     nop                             nop
00006a   0000     nop                             nop
00006b   0000     nop                             nop
00006c   0000     nop                             nop
00006d   c1cc     bset    0x1cc, 0                bset        scl
00006e   0000     nop                             nop
00006f   0000     nop                             nop
000070   000c     return                          return
                                           ;============================================================
                                           ;============================================================
                                           aknow_end_out:
000071   d1cc     bclr    0x1cc, 0                bclr        scl
000072   cfc8     bset    0x1c8, 0x7              bset        sda
000073   cfc9     bset    0x1c9, 0x7              bset        ioset  
000074   0000     nop                             nop
000075   0000     nop                             nop
000076   c1cc     bset    0x1cc, 0                bset        scl
000077   0000     nop                             nop
000078   0000     nop                             nop
000079   000c     return                          return
                                           ;=============================================================
                                           ;=============================================================
                                           aknowledge:
00007a   dfc9     bclr    0x1c9, 0x7              bclr        ioset
00007b   c1cc     bset    0x1cc, 0                bset        scl
00007c   80a8     call    0xa8                    call        delay5us
00007d   ffc8     jbclr   0x1c8, 0x7              jbclr       sda
00007e   c210     bset    0x10, 0x1               bset        errflag
00007f   cfc9     bset    0x1c9, 0x7              bset        ioset
000080   d1cc     bclr    0x1cc, 0                bclr        scl
000081   000c     return                          return
                                           ;=============================================================
                                           ;=============================================================
                                           ;=============================================================
                                           byte_write:  ;写一个byte
000082   3c08     movai   0x8                     movai       08h
000083   5615     movra   0x15                    movra       count
                                           write_start:
000084   ee11     jbset   0x11, 0x7               jbset       temp,7
000085   a088     goto    0x88                    goto        write0
000086   cfc8     bset    0x1c8, 0x7              bset        sda
000087   a089     goto    0x89                    goto        write_count
                                           write0:
000088   dfc8     bclr    0x1c8, 0x7              bclr        sda
                                           write_count:
000089   5211     rlr     0x11                    rlr         temp
00008a   c1cc     bset    0x1cc, 0                bset        scl
00008b   80a8     call    0xa8                    call        delay5us
00008c   d1cc     bclr    0x1cc, 0                bclr        scl
00008d   6a15     djzr    0x15                    djzr        count
00008e   a084     goto    0x84                    goto        write_start
00008f   000c     return                          return
                                           ;=============================================================
                                           ;=============================================================
                                           ;============================================================
                                           starti2c:   ;开始信号
000090   cfc8     bset    0x1c8, 0x7              bset        sda
000091   c1cc     bset    0x1cc, 0                bset        scl
000092   80a8     call    0xa8                    call        delay5us
000093   dfc8     bclr    0x1c8, 0x7              bclr        sda
000094   80a8     call    0xa8                    call        delay5us
000095   d1cc     bclr    0x1cc, 0                bclr        scl
000096   80a8     call    0xa8                    call        delay5us
000097   000c     return                          return
                                           ;=============================================================
                                           ;=============================================================
                                           stopa:   ;结束信号
000098   d1cc     bclr    0x1cc, 0                bclr        scl
000099   dfc8     bclr    0x1c8, 0x7              bclr        sda
00009a   80a8     call    0xa8                    call        delay5us
00009b   c1cc     bset    0x1cc, 0                bset        scl
00009c   80a8     call    0xa8                    call        delay5us
00009d   cfc8     bset    0x1c8, 0x7              bset        sda       
00009e   000c     return                          return
                                           ;=============================================================
                                           ;=============================================================
                                           ;=============================================================
                                           delay10ms:
00009f   7611     clrr    0x11                    clrr        temp
0000a0   3c09     movai   0x9                     movai       09h
0000a1   5612     movra   0x12                    movra       temp1
                                           delay10ms1:
0000a2   0000     nop                             nop
0000a3   6a11     djzr    0x11                    djzr        temp
0000a4   a0a2     goto    0xa2                    goto        delay10ms1
0000a5   6a12     djzr    0x12                    djzr        temp1
0000a6   a0a2     goto    0xa2                    goto        delay10ms1
0000a7   000c     return                          return
                                           ;=============================================================
                                           
                                           delay5us:
0000a8   0000     nop                             nop
0000a9   0000     nop                             nop
0000aa   000c     return                          return
                                           ;=============================================================
                                           ;=============================================================
                                           
                                           
                                            	end


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)

0000 : XX-------------- XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140 : XXXXXXXXXXXXXXXX XXXXXX---------- ---------------- ----------------
07C0 : ---------------- ---------------- ---------------- --------------XX

All other memory blocks unused.

Program Memory Words Used:   165

