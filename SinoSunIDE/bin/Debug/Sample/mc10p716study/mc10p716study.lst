L 1				keyl	equ	$00
L 2				keyh	equ	$01
L 3				mcr		equ $02
L 4				p0		equ $03
L 5				ddr0	equ $04
L 6				p0hcon	equ $05
L 7				tload0l	equ $06
L 8				tload0h equ $07
L 9				tlatl equ $08
L 10				tlath equ $09
L 11				tcr0	equ $0a
L 12				tlatll equ $0b
L 13				tdata1	equ $0b
L 14				tload1	equ $0c
L 15				tcr1	equ $0d
L 16				intc	equ $0e
L 17				opa	equ $0f
L 18				
L 19					org $c0
L 20				t_16ms		equ $c0
L 21				t_3s			equ $c1
L 22				learn_num equ $c2
L 23				send_num 	equ $c3
L 24				times 		equ $c4        ;存储tlatll
L 25				timeh 		equ $c5        ;存储tlath
L 26				timel 		equ $c6        ;存储tlatl
L 27				
L 28				tload_tmp equ $c7
L 29				
L 30				flag0 equ $cf
L 31				unique_flag       equ     7
L 32				pwm_flag       		equ     6
L 33				learn_begin       equ     5
L 34				learn_end 	      equ     4
L 35				learn_err 	      equ     3
L 36				send_begin        equ     2
L 37				send_end          equ     1
L 38				no_carry          equ     0
L 39				               
L 40				learn_index equ $100   ;0x100-0x1ff用来存储码型数据
L 41				
L 42				time_def equ $7f
L 43				
L 44				set_learn_num equ $44
L 45				
L 46					ORG $c000
L 47				start:
L 48	[2]	C000	A6FF		lda #$ff
L 49	[4]	C002	B704		sta ddr0
L 50							
L 51				ram_clrl:          ;清低RAM
L 52	[2]	C004	AEC0		ldx #$c0
L 53				ram_lpl:	
L 54	[5]	C006	7F		clr ,x
L 55	[3]	C007	5C		incx
L 56	[3]	C008	26FC		bne ram_lpl
L 57				
L 58				ram_clrh:          ;清高RAM
L 59	[3]	C00A	5F		clrx
L 60	[2]	C00B	A6FF		lda #$ff
L 61				ram_lph:	
L 62	[6]	C00D	D70100		sta $100,x
L 63	[3]	C010	5C		incx
L 64	[3]	C011	26FA		bne ram_lph	
L 65					
L 66	[3]	C013	201D		bra opa_end 		 ;仿真用
L 67					
L 68				opa_adjust:				;OPA 校准
L 69	[2]	C015	A610		lda #$10
L 70	[4]	C017	B70F		sta opa
L 71	[6]	C019	CDC03A		jsr delay_100us
L 72					
L 73	[3]	C01C	B602		lda mcr
L 74	[2]	C01E	A404		and #$04
L 75	[4]	C020	B7C4		sta times
L 76				
L 77				opa_lp:	
L 78	[5]	C022	3C0F		inc opa
L 79	[6]	C024	CDC03A		jsr delay_100us	
L 80	[5]	C027	0C0F08		brset 6,opa,opa_end
L 81	[3]	C02A	B602		lda mcr
L 82	[2]	C02C	A404		and #$04
L 83	[3]	C02E	B8C4		eor times
L 84	[3]	C030	26F0		bne opa_lp
L 85				opa_end:
L 86	[3]	C032	B60F		lda opa
L 87	[2]	C034	AAC0		ora #$c0
L 88	[4]	C036	B70F		sta opa	
L 89	[3]	C038	2008		bra learn_start
L 90				
L 91				delay_100us:
L 92	[2]	C03A	A632		lda	#$32
L 93				delay_100us_lp:
L 94	[2]	C03C	9D		nop
L 95	[2]	C03D	9D		nop
L 96	[3]	C03E	4A		deca
L 97	[3]	C03F	26FB		bne	delay_100us_lp
L 98	[6]	C041	81		rts
L 99				
L 100				learn_start:
L 101	[5]	C042	3FC0		clr t_16ms
L 102	[2]	C044	A67F		lda #time_def         ;timer0 1分频 定时65535*0.25u=16ms	
L 103	[4]	C046	B707		sta tload0h
L 104	[2]	C048	A67F		lda #time_def
L 105	[4]	C04A	B706		sta tload0l
L 106	[2]	C04C	A601		lda #$01        ;tlath tlatl记录IR上升沿时间，tlatll记录IR下升沿时间
L 107	[4]	C04E	B70A		sta tcr0
L 108					
L 109	[5]	C050	3F0B		clr tdata1
L 110	[2]	C052	A605		lda #5
L 111	[4]	C054	B70C		sta tload1			
L 112	[2]	C056	A602		lda #$02				;timer1 外部计数模式(IR下降沿计数)，记录4个载波时间长度
L 113	[4]	C058	B70D		sta tcr1
L 114					
L 115	[5]	C05A	140A		bset 2,tcr0     ;timer0开启
L 116	[5]	C05C	140D		bset 2,tcr1     ;timer1开启
L 117					
L 118	[5]	C05E	170A		bclr 3,tcr0
L 119					
L 120	[2]	C060	A680		lda #$80        ;IRIN上升沿中断使能
L 121	[4]	C062	B70E		sta intc
L 122					
L 123	[5]	C064	3FC3		clr send_num
L 124				 
L 125	[2]	C066	9A		cli	
L 126					;学习模式
L 127					;学习模式开始后，timer0处于定时模式，每16ms溢出进入中断1次,用于产生时基
L 128					;波形开始后时IRIN上升沿重载timer0，并产生int0中断进入int0中断服务程序，清int0中断标志
L 129					;在大约70u内不停读取int0中断标志，为高表示带载波,否则为无载波
L 130					;如果为无载波，则只用int0中断上降沿记录每次的时间直到学习结束
L 131					;如果在带载波，关闭int1中断，等4次计数结束进入tmr1中断服务程序
L 132					;tmr1中断中计算载波宽度，将载波宽度赋值到t1load，并将timer1设置成包络模式，开启int1下升沿中断使能
L 133					;int1中断中记录每次的时间，同时改变tlath/tlatl的锁存沿和int1的中断触发沿直到学习结束
L 134					
L 135				learn_ing:
L 136	[5]	C067	06CF5F		brset learn_err,flag0,learn_error
L 137	[5]	C06A	09CFFA		brclr learn_end,flag0,learn_ing
L 138					
L 139					;发码模式
L 140					;带载波，timer1配置成pwm模式输出载波信号，开关受timer0中断信号控制，timer0控制时间，mcr配置irout由pwm输出
L 141					;timer0为自加载计数器，开启时写不会立即生效，在溢出后才加载，所以时间要提前一个中断中写
L 142					;如果定时时间超过16ms，先计时超过部分，然后关闭TMR0EN，关闭timer0触发timer1开关，等超出部分计时完毕再打开
L 143					;timer1同上，只是需要将TCLR设置成1，使pwm处于自关闭状态
L 144					
L 145	[5]	C06D	1F0F		bclr 7,opa                    ;关闭opa
L 146	[5]	C06F	1A02	 bset 5,mcr
L 147	[5]	C071	1103	 bclr 0,p0
L 148				
L 149				send_loop:
L 150	[3]	C073	B6C3	 lda send_num                  ;把发码个数暂存,用于判断发码结束
L 151	[4]	C075	B7C2		sta learn_num      
L 152	[5]	C077	3FC3		clr send_num
L 153				
L 154				send_next: 		
L 155	[5]	C079	01CF11		brclr no_carry,flag0,carry_on
L 156				carry_off:	
L 157	[3]	C07C	B6C4		lda times
L 158	[2]	C07E	A07F		sub #time_def
L 159	[3]	C080	43		coma
L 160	[4]	C081	B70C		sta tload1
L 161	[5]	C083	3F0B		clr tdata1             
L 162	[2]	C085	A640		lda #$40                      ;无载波脉冲设置
L 163	[4]	C087	B70D		sta tcr1	
L 164	[5]	C089	100D		bset 0,tcr1                   ;自关闭模式
L 165	[3]	C08B	2009		bra send_start	
L 166				carry_on:	
L 167	[3]	C08D	B6C4		lda times
L 168	[6]	C08F	CDC0C1		jsr set_pwm	
L 169	[2]	C092	A640		lda #$40                      ;带载波脉冲设置
L 170	[4]	C094	B70D		sta tcr1	
L 171				send_start:
L 172	[2]	C096	A601		lda #$01 
L 173	[4]	C098	B707		sta tload0h
L 174	[2]	C09A	A620	 lda #$20
L 175	[4]	C09C	B706		sta tload0l                    ;tload0h带缓冲，写tload0l将把tload0h和tload0l的值同时置入到预加载寄存器中	
L 176	[2]	C09E	A600		lda #$00         
L 177	[4]	C0A0	B70A		sta tcr0	
L 178					;bset 3,tcr1
L 179	[5]	C0A2	170D		bclr 3,tcr1
L 180	[5]	C0A4	140A		bset 2,tcr0
L 181	[5]	C0A6	140D		bset 2,tcr1
L 182	[5]	C0A8	14CF		bset send_begin,flag0
L 183	[5]	C0AA	1CCF		bset pwm_flag,flag0
L 184	[5]	C0AC	1003	 bset 0,p0
L 185	[2]	C0AE	A620		lda #$20   ;#$30                      
L 186	[4]	C0B0	B702		sta mcr	
L 187				
L 188				send_ing:
L 189	[5]	C0B2	03CFFD		brclr send_end,flag0,send_ing
L 190					
L 191				
L 192	[3]	C0B5	B6C2	 lda learn_num
L 193	[4]	C0B7	B7C3	 sta send_num
L 194	[5]	C0B9	13CF	 bclr send_end,flag0
L 195	[5]	C0BB	1103	 bclr 0,p0
L 196	[5]	C0BD	1902	 bclr 4,mcr
L 197	[3]	C0BF	20B2		bra send_loop                            ;此处添加其他程序					
L 198				
L 199				set_pwm:                           ;设置载波周期
L 200	[3]	C0C1	4A		deca
L 201	[4]	C0C2	B70C		sta tload1
L 202	[3]	C0C4	4C		inca
L 203	[3]	C0C5	44		lsra
L 204	[4]	C0C6	B70B		sta tdata1
L 205	[6]	C0C8	81		rts
L 206				
L 207				learn_error:
L 208	[5]	C0C9	17CF		bclr learn_err,flag0	
L 209	[3]	C0CB	20FE		bra *
L 210				
L 211				kbi:
L 212	[5]	C0CD	1D02		bclr 6,mcr	
L 213	[9]	C0CF	80		rti
L 214				
L 215				tmi0:																
L 216	[5]	C0D0	1F0A		bclr 7,tcr0	
L 217	[5]	C0D2	0ACF1B		brset learn_begin,flag0,tmi0_learn
L 218	[5]	C0D5	04CF31		brset send_begin,flag0,tmi0_send
L 219	[5]	C0D8	02CF27		brset send_end,flag0,tmi0_send_end_over
L 220	[5]	C0DB	3CC0		inc t_16ms                          ;信号等待定时
L 221	[3]	C0DD	B6C0		lda t_16ms
L 222	[2]	C0DF	A1C8		cmp #200
L 223	[3]	C0E1	260C		bne tmi0_end
L 224	[5]	C0E3	3FC0		clr t_16ms
L 225	[5]	C0E5	3CC1		inc t_3s
L 226	[3]	C0E7	B6C1		lda t_3s
L 227	[2]	C0E9	A128		cmp #40
L 228	[3]	C0EB	2602		bne tmi0_end
L 229	[5]	C0ED	3FC1		clr t_3s                            ;2分钟无信号超时
L 230					;bset learn_err,flag0                ;置位学习错误标志
L 231				tmi0_end:		
L 232	[9]	C0EF	80		rti
L 233				tmi0_learn:                           ;学习过程中溢出，在数列中插入特殊值FF
L 234	[5]	C0F0	3CC3		inc send_num	
L 235				tmi0_learn_index_next:	
L 236	[5]	C0F2	3CC0		inc t_16ms                         
L 237	[3]	C0F4	B6C0		lda t_16ms		
L 238	[2]	C0F6	A114		cmp #20
L 239	[3]	C0F8	2701		beq tmi0_learn_end	                ;最长学习320ms
L 240	[9]	C0FA	80		rti
L 241				tmi0_learn_end:	
L 242	[5]	C0FB	18CF		bset learn_end,flag0
L 243	[5]	C0FD	1BCF		bclr learn_begin,flag0
L 244	[5]	C0FF	3F0E		clr intc	      
L 245	[9]	C101	80		rti	
L 246				
L 247				tmi0_send_end_over:
L 248	[5]	C102	1C0A		bset 6,tcr0
L 249	[5]	C104	3F07		clr tload0h
L 250	[5]	C106	3F06		clr tload0l
L 251	[9]	C108	80		rti	
L 252				
L 253				tmi0_send:                           ;发码	
L 254	[5]	C109	160D		bset 3,tcr1
L 255	[5]	C10B	1802		bset 4,mcr
L 256	[3]	C10D	BEC3		ldx send_num
L 257	[5]	C10F	D60100		lda learn_index,x
L 258	[3]	C112	43		coma
L 259	[3]	C113	271D		beq tmi0_send_unique
L 260	[5]	C115	0ECF37		brset unique_flag,flag0,tmi0_send_unique_end
L 261					
L 262	[2]	C118	A67F		lda #time_def
L 263	[5]	C11A	D00101		sub learn_index+1,x
L 264	[4]	C11D	B7C7		sta tload_tmp
L 265	[2]	C11F	A67F		lda #time_def
L 266	[5]	C121	D20100		sbc learn_index,x
L 267	[4]	C124	B707		sta tload0h
L 268	[3]	C126	B6C7		lda tload_tmp
L 269	[4]	C128	B706		sta tload0l	
L 270	[5]	C12A	3CC3		inc send_num
L 271	[5]	C12C	3CC3		inc send_num
L 272	[5]	C12E	140D		bset 2,tcr1	                        ;开启溢出触发	
L 273	[3]	C130	2039		bra tmi0_send_next
L 274				
L 275				tmi0_send_unique:
L 276	[5]	C132	0ECF0E		brset unique_flag,flag0,tmi0_send_unique_loop
L 277	[2]	C135	A67F		lda #time_def											
L 278	[4]	C137	B707		sta tload0h
L 279	[4]	C139	B706		sta tload0l	
L 280	[5]	C13B	3CC3		inc send_num
L 281	[5]	C13D	140D		bset 2,tcr1
L 282	[5]	C13F	1ECF		bset unique_flag,flag0
L 283	[3]	C141	2028		bra tmi0_send_next		
L 284				
L 285				tmi0_send_unique_loop:
L 286	[2]	C143	A67F		lda #time_def											
L 287	[4]	C145	B707		sta tload0h
L 288	[4]	C147	B706		sta tload0l	
L 289	[5]	C149	3CC3		inc send_num
L 290	[5]	C14B	150D		bclr 2,tcr1
L 291	[3]	C14D	201C		bra tmi0_send_next
L 292				
L 293				tmi0_send_unique_end:
L 294	[2]	C14F	A67F		lda #time_def
L 295	[5]	C151	D00101		sub learn_index+1,x
L 296	[4]	C154	B7C7		sta tload_tmp
L 297	[2]	C156	A67F		lda #time_def
L 298	[5]	C158	D20100		sbc learn_index,x
L 299	[4]	C15B	B707		sta tload0h
L 300	[3]	C15D	B6C7		lda tload_tmp
L 301	[4]	C15F	B706		sta tload0l	
L 302	[5]	C161	3CC3		inc send_num
L 303	[5]	C163	3CC3		inc send_num 
L 304	[5]	C165	150D		bclr 2,tcr1
L 305	[5]	C167	1FCF		bclr unique_flag,flag0
L 306	[3]	C169	2000		bra tmi0_send_next		
L 307				
L 308				tmi0_send_next:                       ;是否发完	
L 309	[3]	C16B	BEC3		ldx send_num
L 310	[3]	C16D	B3C2		cpx learn_num
L 311	[3]	C16F	2701		beq tmi0_send_end
L 312	[9]	C171	80		rti	
L 313				tmi0_send_end:                        ;发码结束
L 314	[5]	C172	15CF		bclr send_begin,flag0
L 315	[5]	C174	12CF		bset send_end,flag0
L 316	[9]	C176	80		rti		
L 317				
L 318				
L 319				
L 320						
L 321				tmi1:	                          ;4个载波脉冲计数溢出中断，设置去包络时间      
L 322	[3]	C177	B608		lda tlatl
L 323	[3]	C179	BE09		ldx tlath
L 324	[4]	C17B	B7C6		sta timel
L 325	[4]	C17D	BFC5		stx timeh       
L 326					         
L 327	[3]	C17F	B6C4		lda times                      ;计算载波周期
L 328	[3]	C181	B0C6		sub timel
L 329	[4]	C183	B7C4		sta times
L 330	[2]	C185	A67F		lda #time_def
L 331	[3]	C187	B2C5		sbc timeh
L 332	[3]	C189	44		lsra                          ;除2
L 333	[5]	C18A	36C4		ror times
L 334	[3]	C18C	44		lsra                          ;除2
L 335	[5]	C18D	36C4		ror times
L 336	[3]	C18F	B6C4		lda times                     ;设置载波周期
L 337	[2]	C191	AB05		add #5
L 338	[6]	C193	CDC0C1		jsr set_pwm
L 339				
L 340				 ;lda #$f0
L 341				 ;sta tload1
L 342				 
L 343	[2]	C196	A641		lda #$41                      ;包络模式
L 344	[4]	C198	B70D		sta tcr1
L 345	[5]	C19A	140D		bset 2,tcr1
L 346	[5]	C19C	110A		bclr 0,tcr0                   ;上升沿采样
L 347	[5]	C19E	120A		bset 1,tcr0                   ;触发选择IRINT
L 348	[2]	C1A0	A60A		lda #$0a                      ;开启包络信号IRINT中断
L 349	[4]	C1A2	B70E		sta intc	
L 350	[5]	C1A4	170A		bclr 3,tcr0                   ;允许触发重载
L 351	[9]	C1A6	80		rti	
L 352				
L 353				int0:																   ;IRIN第一个下降沿触发进入中断，timer0自动重载
L 354	[3]	C1A7	B608		lda tlatl
L 355	[3]	C1A9	BE09		ldx tlath
L 356	[4]	C1AB	B7C6		sta timel
L 357	[4]	C1AD	BFC5		stx timeh  
L 358	[5]	C1AF	190E		bclr 4,intc
L 359	[5]	C1B1	1003	 bset 0,p0
L 360	[5]	C1B3	00CF2C		brset no_carry,flag0,int0_no_carry_end	;无载波分支
L 361	[5]	C1B6	1ACF		bset learn_begin,flag0
L 362	[2]	C1B8	A644		lda #set_learn_num                             ;学习个数
L 363	[4]	C1BA	B7C2		sta learn_num
L 364	[5]	C1BC	080E0B		brset 4,intc,int0_carry							 ;波形开始后70u中读取标志位，判断有无载波
L 365	[2]	C1BF	A606		lda #6
L 366				delay_70us:
L 367	[5]	C1C1	080E06		brset 4,intc,int0_carry							
L 368	[3]	C1C4	4A		deca
L 369	[3]	C1C5	26FA		bne delay_70us
L 370	[5]	C1C7	090E0D		brclr 4,intc,int0_no_carry           
L 371				int0_carry:														 ;带载波设置
L 372	[3]	C1CA	B60B		lda tlatll                           ;记录脉冲宽度
L 373	[4]	C1CC	B7C4		sta times
L 374	[5]	C1CE	11CF		bclr no_carry,flag0                  ;带载波	
L 375	[5]	C1D0	1F0E		bclr 7,intc													 ;关闭IRIN中断	
L 376	[5]	C1D2	190E		bclr 4,intc													 ;清int0中断标志
L 377	[5]	C1D4	110A		bclr 0,tcr0                          ;改变tlat采样沿口
L 378	[9]	C1D6	80		rti
L 379				int0_no_carry:
L 380	[5]	C1D7	10CF		bset no_carry,flag0                  ;不带载波
L 381	[3]	C1D9	B60B		lda tlatll                           ;记录脉冲宽度
L 382	[4]	C1DB	B7C4		sta times
L 383	[5]	C1DD	1C0D		bset 6,tcr1												   ;关闭tmi1中断
L 384	[5]	C1DF	170A		bclr 3,tcr0                          ;允许触发重载
L 385	[9]	C1E1	80		rti
L 386				int0_no_carry_end:										 ;判断无载波码型是否学习结束
L 387	[6]	C1E2	CDC225		jsr save_time	
L 388	[5]	C1E5	170A		bclr 3,tcr0                          ;允许触发重载
L 389	[5]	C1E7	3AC2		dec learn_num	                              
L 390	[3]	C1E9	2701		beq int0_learn_end	
L 391	[9]	C1EB	80		rti
L 392				int0_learn_end:
L 393	[5]	C1EC	18CF		bset learn_end,flag0      
L 394	[5]	C1EE	1BCF		bclr learn_begin,flag0           
L 395	[5]	C1F0	1F0E		bclr 7,intc                          ;无载波码型学习完成，关闭中断
L 396	[5]	C1F2	190E		bclr 4,intc
L 397	[9]	C1F4	80		rti
L 398				
L 399				int1:                               ;记录带载波码型翻转时间
L 400	[3]	C1F5	B608		lda tlatl
L 401	[3]	C1F7	BE09		ldx tlath
L 402	[4]	C1F9	B7C6		sta timel
L 403	[4]	C1FB	BFC5		stx timeh  
L 404	[5]	C1FD	110E		bclr 0,intc
L 405				
L 406	[2]	C1FF	A602	 lda #$02
L 407	[3]	C201	B803	 eor p0
L 408	[4]	C203	B703	 sta p0
L 409				 
L 410	[6]	C205	CDC225		jsr save_time
L 411	[5]	C208	3AC2		dec learn_num       							;判断带载波码型是否学习结束
L 412	[3]	C20A	2711		beq int1_end
L 413	[5]	C20C	020E07		brset 1,intc,code_posedge         ;改变tlat采样沿口和IRIN中断沿口
L 414				code_negedge:
L 415	[5]	C20F	120E		bset 1,intc                       
L 416	[5]	C211	110A		bclr 0,tcr0
L 417	[5]	C213	170A		bclr 3,tcr0                          ;允许触发重载	
L 418	[9]	C215	80		rti
L 419				code_posedge:	
L 420	[5]	C216	130E		bclr 1,intc
L 421	[5]	C218	100A		bset 0,tcr0
L 422	[5]	C21A	170A		bclr 3,tcr0                          ;允许触发重载	
L 423	[9]	C21C	80		rti	
L 424				int1_end:
L 425	[5]	C21D	18CF		bset learn_end,flag0
L 426	[5]	C21F	1BCF		bclr learn_begin,flag0 
L 427	[5]	C221	3F0E		clr intc	                         ;带载波码型学习完成，关闭中断
L 428	[9]	C223	80		rti
L 429				
L 430				swii:  
L 431	[9]	C224	80	  rti
L 432				
L 433				save_time:
L 434	[3]	C225	BEC3		ldx send_num    
L 435	[3]	C227	B6C5		lda timeh
L 436	[6]	C229	D70100		sta learn_index,x	
L 437	[3]	C22C	5C		incx
L 438	[3]	C22D	B6C6		lda timel	
L 439	[6]	C22F	D70100		sta learn_index,x
L 440	[3]	C232	5C		incx
L 441	[4]	C233	BFC3		stx send_num
L 442	[6]	C235	81		rts
L 443					
L 444					
L 445				;interrupt vector
L 446					ORG $fFF2
L 447		FFF2	C0CD		FDB kbi	
L 448					ORG $fFF4
L 449		FFF4	C0D0		FDB tmi0
L 450					ORG $fFF6
L 451		FFF6	C177		FDB tmi1
L 452					ORG $fFF8
L 453		FFF8	C1A7		FDB int0	
L 454					ORG $fFFA
L 455		FFFA	C1F5		FDB int1	
L 456					ORG $fFFC
L 457		FFFC	C224		FDB swii
L 458					
L 459					ORG $fFFE
L 460		FFFE	C000		FDB start
